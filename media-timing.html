<!DOCTYPE html>
<html lang="en" class="html" data-theme="dark"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>
    
      How do time media over the network or when playing back
    
  </title>

  <!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="How do time media over the network or when playing back" />
<meta name="author" content="Liz3" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="So you’ve got your discord bot or a library for playing video files but somethings just off? Lag after some time or even directly from the beginning? Chances are that maybe the timing is off, and to be fair its really hard to get it right. Heres how to solve it." />
<meta property="og:description" content="So you’ve got your discord bot or a library for playing video files but somethings just off? Lag after some time or even directly from the beginning? Chances are that maybe the timing is off, and to be fair its really hard to get it right. Heres how to solve it." />
<link rel="canonical" href="https://liz3.github.io/blog//blog/media-timing.html" />
<meta property="og:url" content="https://liz3.github.io/blog//blog/media-timing.html" />
<meta property="og:site_name" content="Liz3 Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-11-23T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="How do time media over the network or when playing back" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"https://liz3.github.io/blog//blog/media-timing.html"},"description":"So you’ve got your discord bot or a library for playing video files but somethings just off? Lag after some time or even directly from the beginning? Chances are that maybe the timing is off, and to be fair its really hard to get it right. Heres how to solve it.","url":"https://liz3.github.io/blog//blog/media-timing.html","@type":"BlogPosting","headline":"How do time media over the network or when playing back","dateModified":"2021-11-23T00:00:00+00:00","datePublished":"2021-11-23T00:00:00+00:00","author":{"@type":"Person","name":"Liz3"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <link type="application/atom+xml" rel="alternate" href="https://liz3.github.io/blog//blog/feed.xml" title="Liz3 Blog" />

  <link rel="shortcut icon" type="image/x-icon" href="//blog/logo.png" />
  <link rel="stylesheet" href="/blog/assets/css/main.css" />
  
    <script type="text/javascript">
  window.addEventListener('load', themeChange);
  const currentTheme = localStorage.getItem('theme') ? localStorage.getItem('theme') : null;
  if (currentTheme)
    document.documentElement.setAttribute('data-theme', currentTheme);

  function themeChange() {
    let button = document.querySelector('.theme-toggle');

    button.addEventListener('click', function (e) {
      let currentTheme = document.documentElement.getAttribute('data-theme');
      if (currentTheme === 'dark') {
        transition();
        document.documentElement.setAttribute('data-theme', 'light');
        localStorage.setItem('theme', 'light');
      } else {
        transition();
        document.documentElement.setAttribute('data-theme', 'dark');
        localStorage.setItem('theme', 'dark');
      }
    });

    let transition = () => {
      document.documentElement.classList.add('transition');
      window.setTimeout(() => {
        document.documentElement.classList.remove('transition');
      }, 1000);
    }
  }
</script>


  
</head>
<body>
    <main class="page-content" aria-label="Content">
      <div class="w">
        <a href="/blog/">home..</a>
<h1 class="post-title">How do time media over the network or when playing back</h1>
<p class="post-date text-bold text-upcase">
  
    <span>November 2021</span>
  
</p>

<p>So you’ve got your discord bot or a library for playing video files but somethings just off? Lag after some time or even directly from the beginning?
Chances are that maybe the timing is off, and to be fair its really hard to get it right. Heres how to solve it.</p>

<h2 id="the-naive-approach">The naive approach</h2>
<p>Timing video/audio cant be hard can it? Turns out its not as straight forward as you might think.</p>

<p>The Naive and also my first attempt was just to, send <em>x</em> amount of data for a time period, measure how long that takes and then <em>sleep</em> for the time that took.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>start = now()

to_send = prepare_data() // some encoder/decoder maybe
send_data(to_send)  // send data to a blip frame or some network endpoint.

elapsed = now() - start
if elapsed &gt; 0 do
  sleep(data_time_amount - elapsed)
end
</code></pre></div></div>
<p>That seams reasonable right?</p>

<h2 id="the-problem">The Problem</h2>
<p>The issue with that approach is that its <em>relative</em>.
The time passed is suspect to the operating system suspending the process, giving it other priority and other factors.
Which means while the approach is <em>theoretically</em> correct, its not going to work unless there is 0 delay beyond your desired one, which will never happen.</p>

<p>Regarding that its also interesting because you learn about kernel schedulers, when i did this, it was often more a problem on macOS then on gnu/linux because the linux kernel scheduler is a lot more aggressive and resource <em>giving</em> then macOS, macOS will make sure its own services have enough priority to keep certain things like the desktop running smoothly.</p>

<h2 id="the-solution">The solution</h2>
<p>I put <em>relative</em> in the previous section in italic for a reason because in that problem is the solution, we need to time in a <em>absolute</em> approach.
That works because(assuming we know the audio packet/frame or video frame duration) we can calculate the position we <strong>should</strong> reach.</p>

<p>Great how do we do that?</p>

<p>Here the solution in c++ from my project <a href="https://github.com/liz3/tokio">tokio</a> in c++</p>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;thread&gt;
#include &lt;chrono&gt;
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="p">;</span>

<span class="c1">// ...</span>

<span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">time_point</span> <span class="n">start_point</span> <span class="o">=</span> <span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="kt">size_t</span> <span class="n">elapsed_frames</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">double</span> <span class="n">frame_duration</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">;</span>
<span class="k">while</span><span class="p">(</span><span class="n">should_play</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">send_data</span><span class="p">();</span>
  <span class="n">elapsed_frames</span><span class="o">++</span><span class="p">;</span>

  <span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">time_point</span> <span class="n">point_now</span> <span class="o">=</span> <span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
  <span class="n">duration</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">absolute_elapsed</span> <span class="o">=</span> <span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">duration</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">point_now</span> <span class="o">-</span> <span class="n">start_point</span><span class="p">);</span>
  <span class="kt">double</span> <span class="n">current_play_head</span> <span class="o">=</span> <span class="n">frame_duration</span> <span class="o">*</span> <span class="n">elapsed_frames</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">to_delay</span> <span class="o">=</span> <span class="n">current_play_head</span> <span class="o">-</span> <span class="n">absolute_elapsed</span><span class="p">.</span><span class="n">count</span><span class="p">();</span>
  <span class="k">if</span><span class="p">(</span><span class="n">to_delay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">microseconds</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">to_delay</span> <span class="o">*</span> <span class="mi">1000000</span><span class="p">)));</span>
  <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div>
<p>So what do we do here?
First we need to know 2 things:</p>
<ol>
  <li>the current time in a high resolution - <code class="language-plaintext highlighter-rouge">start_point</code></li>
  <li>how long in absolute time one iteration of our loop passes, here <code class="language-plaintext highlighter-rouge">frame_duration</code> 2% of a second.</li>
</ol>

<p>In the loop we send our data and then increment a simple counter per iteration.</p>

<p>Then we calculate the <strong>absolute</strong> time elapsed since we started playing(<code class="language-plaintext highlighter-rouge">absolute_elapsed</code>), that gets rid of that relative issue from the naive approach.
After that we calculated the <code class="language-plaintext highlighter-rouge">current_play_head</code>, basically where the audio should be after the sleep we are now starting.
Lastly we calculate the actual amount to sleep(<code class="language-plaintext highlighter-rouge">to_delay</code>) by substracting the elapsed time from the play head.</p>

<p>Then if needed we sleep by that amount.</p>

<h2 id="conclusion">Conclusion</h2>
<p>I learned this way of calculating by reading the discord.py source code and how they do it.</p>

<p>I hope you where able to take something from this and maybe even use it!</p>


        
          <button title="Toggle Theme" class="theme-toggle">
  <svg viewBox="0 0 32 32" width="24" height="24" fill="currentcolor">
    <circle cx="16" cy="16" r="14" fill="none" stroke="currentcolor" stroke-width="4"></circle>
    <path d="
             M 16 0
             A 16 16 0 0 0 16 32
             z">
    </path>
  </svg>
</button>

        
        <div class="credits">&copy;&nbsp;2021&nbsp;Liz3
          &nbsp;
          •
          &nbsp;Theme&nbsp; <a href="https://github.com/abhinavs/moonwalk" target="_blank" rel="noreferrer">Moonwalk</a>
        </div>
      </div>
    </main><script async defer data-soopr-token="" src="https://sdk.soopr.co/soopr.js"></script></body>
</html>
